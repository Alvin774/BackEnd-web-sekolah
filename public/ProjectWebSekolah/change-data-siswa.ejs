<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Siswa Lengkap</title>
  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    crossorigin="anonymous"
  />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link 
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" 
    rel="stylesheet" 
  />
  <style>
    body {
      background-color: #f5f5f5;
      font-family: 'Poppins', sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #27ae60;
    }
    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .form-section h4 {
      margin-bottom: 15px;
      color: #4e73df;
    }
    .btn-group {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Detail Data Siswa</h2>
    <form id="updateForm">
      <!-- Hidden input untuk ID -->
      <input type="hidden" id="id" name="id">

      <!-- Informasi Pendaftaran -->
      <div class="form-section">
        <h4>Informasi Pendaftaran</h4>
        <div class="mb-3">
          <label for="taPendaftaran" class="form-label">Tahun Pendaftaran</label>
          <input type="text" id="taPendaftaran" name="taPendaftaran" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="jalurPendaftaran" class="form-label">Jalur Pendaftaran</label>
          <input type="text" id="jalurPendaftaran" name="jalurPendaftaran" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="program" class="form-label">Program</label>
          <input type="text" id="program" name="program" class="form-control" required>
        </div>
      </div>

      <!-- Data Siswa -->
      <div class="form-section">
        <h4>Data Siswa</h4>
        <div class="mb-3">
          <label for="namaLengkap" class="form-label">Nama Lengkap</label>
          <input type="text" id="namaLengkap" name="namaLengkap" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="namaPanggilan" class="form-label">Nama Panggilan</label>
          <input type="text" id="namaPanggilan" name="namaPanggilan" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="nisn" class="form-label">NISN</label>
          <input type="text" id="nisn" name="nisn" class="form-control">
        </div>
        <div class="mb-3">
          <label for="nis" class="form-label">NIS</label>
          <input type="text" id="nis" name="nis" class="form-control">
        </div>
        <div class="mb-3">
          <label for="nik" class="form-label">NIK / No. KIA</label>
          <input type="text" id="nik" name="nik" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="tempatLahir" class="form-label">Tempat Lahir</label>
          <input type="text" id="tempatLahir" name="tempatLahir" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="tanggalLahir" class="form-label">Tanggal Lahir</label>
          <input type="date" id="tanggalLahir" name="tanggalLahir" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="jenisKelamin" class="form-label">Jenis Kelamin</label>
          <select id="jenisKelamin" name="jenisKelamin" class="form-select" required>
            <option value="">Pilih</option>
            <option value="Laki-laki">Laki-laki</option>
            <option value="Perempuan">Perempuan</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="agama" class="form-label">Agama</label>
          <select id="agama" name="agama" class="form-select" required>
            <option value="">Pilih</option>
            <option value="Islam">Islam</option>
            <option value="Kristen">Kristen</option>
            <option value="Katolik">Katolik</option>
            <option value="Hindu">Hindu</option>
            <option value="Buddha">Buddha</option>
            <option value="Konghucu">Konghucu</option>
            <option value="Lainnya">Lainnya</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="alamatSiswa" class="form-label">Alamat Siswa</label>
          <textarea id="alamatSiswa" name="alamatSiswa" class="form-control" rows="2" required></textarea>
        </div>
      </div>

      <!-- Alamat Lengkap Siswa -->
      <div class="form-section">
        <h4>Alamat Lengkap Siswa</h4>
        <div class="mb-3">
          <label for="rt" class="form-label">RT</label>
          <input type="text" id="rt" name="rt" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="rw" class="form-label">RW</label>
          <input type="text" id="rw" name="rw" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="desa" class="form-label">Desa</label>
          <input type="text" id="desa" name="desa" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="kecamatan" class="form-label">Kecamatan</label>
          <input type="text" id="kecamatan" name="kecamatan" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="kabupaten" class="form-label">Kabupaten</label>
          <input type="text" id="kabupaten" name="kabupaten" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="provinsi" class="form-label">Provinsi</label>
          <input type="text" id="provinsi" name="provinsi" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="kodePos" class="form-label">Kode Pos</label>
          <input type="text" id="kodePos" name="kodePos" class="form-control" required>
        </div>
      </div>

      <!-- Data Orang Tua -->
      <div class="form-section">
        <h4>Data Orang Tua</h4>
        <div class="mb-3">
          <label for="namaAyah" class="form-label">Nama Ayah</label>
          <input type="text" id="namaAyah" name="namaAyah" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="pekerjaanAyah" class="form-label">Pekerjaan Ayah</label>
          <input type="text" id="pekerjaanAyah" name="pekerjaanAyah" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="pendidikanAyah" class="form-label">Pendidikan Ayah</label>
          <input type="text" id="pendidikanAyah" name="pendidikanAyah" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="namaIbu" class="form-label">Nama Ibu</label>
          <input type="text" id="namaIbu" name="namaIbu" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="pekerjaanIbu" class="form-label">Pekerjaan Ibu</label>
          <input type="text" id="pekerjaanIbu" name="pekerjaanIbu" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="pendidikanIbu" class="form-label">Pendidikan Ibu</label>
          <input type="text" id="pendidikanIbu" name="pendidikanIbu" class="form-control" required>
        </div>
      </div>

      <!-- Data Wali (Opsional) -->
      <div class="form-section">
        <h4>Data Wali (Opsional)</h4>
        <div class="mb-3">
          <label for="hubunganWali" class="form-label">Hubungan Wali</label>
          <input type="text" id="hubunganWali" name="hubunganWali" class="form-control">
        </div>
        <div class="mb-3">
          <label for="namaWali" class="form-label">Nama Wali</label>
          <input type="text" id="namaWali" name="namaWali" class="form-control">
        </div>
        <div class="mb-3">
          <label for="pekerjaanWali" class="form-label">Pekerjaan Wali</label>
          <input type="text" id="pekerjaanWali" name="pekerjaanWali" class="form-control">
        </div>
        <div class="mb-3">
          <label for="pendidikanWali" class="form-label">Pendidikan Wali</label>
          <input type="text" id="pendidikanWali" name="pendidikanWali" class="form-control">
        </div>
      </div>

      <!-- Data Sekolah Asal -->
      <div class="form-section">
        <h4>Data Sekolah Asal</h4>
        <div class="mb-3">
          <label for="jenisPendaftaran" class="form-label">Jenis Pendaftaran</label>
          <select id="jenisPendaftaran" name="jenisPendaftaran" class="form-select" required>
            <option value="">Pilih</option>
            <option value="Peserta Didik Baru">Peserta Didik Baru</option>
            <option value="Peserta Didik Pindahan">Peserta Didik Pindahan</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="namaSekolah" class="form-label">Nama Sekolah</label>
          <input type="text" id="namaSekolah" name="namaSekolah" class="form-control">
        </div>
        <div class="mb-3">
          <label for="alamatSekolah" class="form-label">Alamat Sekolah</label>
          <textarea id="alamatSekolah" name="alamatSekolah" class="form-control" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label for="pindahanKelas" class="form-label">Pindahan Kelas</label>
          <input type="text" id="pindahanKelas" name="pindahanKelas" class="form-control">
        </div>
      </div>

      <!-- Kontak -->
      <div class="form-section">
        <h4>Kontak</h4>
        <div class="mb-3">
          <label for="noHp" class="form-label">No HP / WA</label>
          <input type="text" id="noHp" name="noHp" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="kontakEmail" class="form-label">Email</label>
          <input type="email" id="kontakEmail" name="kontakEmail" class="form-control" required>
        </div>
      </div>

      <!-- Registered By -->
      <div class="form-section">
        <h4>Registered By</h4>
        <div class="mb-3">
          <label for="registeredBy" class="form-label">Registered By</label>
          <input type="text" id="registeredBy" name="registeredBy" class="form-control" required>
        </div>
      </div>

      <!-- Tombol Update, Print & Kembali -->
      <div class="btn-group d-flex justify-content-center">
        <button type="submit" class="btn btn-primary me-2">Perbarui Data</button>
        <button type="button" id="printButton" class="btn btn-warning me-2">Print PDF</button>
        <a href="admin-data-siswa.html" class="btn btn-secondary">Kembali ke Daftar</a>
      </div>
    </form>
  </div>

  <!-- jsPDF dan AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    // Fungsi untuk mengambil parameter dari URL
    function getParameterByName(name, url = window.location.href) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Fungsi untuk memuat data siswa berdasarkan ID dari query string
    async function loadDataSiswa() {
      const id = getParameterByName('id');
      if (!id) {
        alert('ID pendaftar tidak ditemukan.');
        return;
      }
      try {
        const response = await fetch(`/api/pendaftaran/${id}`);
        if (!response.ok) throw new Error('Gagal mengambil data pendaftaran');
        const data = await response.json();

        // Isi setiap field dengan data yang diambil
        document.getElementById('id').value = data.id;
        // Informasi Pendaftaran
        document.getElementById('taPendaftaran').value = data.taPendaftaran;
        document.getElementById('jalurPendaftaran').value = data.jalurPendaftaran;
        document.getElementById('program').value = data.program;
        // Data Siswa
        document.getElementById('namaLengkap').value = data.namaLengkap;
        document.getElementById('namaPanggilan').value = data.namaPanggilan;
        document.getElementById('nisn').value = data.nisn || '';
        document.getElementById('nis').value = data.nis || '';
        document.getElementById('nik').value = data.nik;
        document.getElementById('tempatLahir').value = data.tempatLahir;
        document.getElementById('tanggalLahir').value = data.tanggalLahir;
        document.getElementById('jenisKelamin').value = data.jenisKelamin;
        document.getElementById('agama').value = data.agama;
        document.getElementById('alamatSiswa').value = data.alamatSiswa;
        // Alamat Lengkap Siswa
        document.getElementById('rt').value = data.rt;
        document.getElementById('rw').value = data.rw;
        document.getElementById('desa').value = data.desa;
        document.getElementById('kecamatan').value = data.kecamatan;
        document.getElementById('kabupaten').value = data.kabupaten;
        document.getElementById('provinsi').value = data.provinsi;
        document.getElementById('kodePos').value = data.kodePos;
        // Data Orang Tua
        document.getElementById('namaAyah').value = data.namaAyah;
        document.getElementById('pekerjaanAyah').value = data.pekerjaanAyah;
        document.getElementById('pendidikanAyah').value = data.pendidikanAyah;
        document.getElementById('namaIbu').value = data.namaIbu;
        document.getElementById('pekerjaanIbu').value = data.pekerjaanIbu;
        document.getElementById('pendidikanIbu').value = data.pendidikanIbu;
        // Data Wali (Opsional)
        document.getElementById('hubunganWali').value = data.hubunganWali || '';
        document.getElementById('namaWali').value = data.namaWali || '';
        document.getElementById('pekerjaanWali').value = data.pekerjaanWali || '';
        document.getElementById('pendidikanWali').value = data.pendidikanWali || '';
        // Data Sekolah Asal
        document.getElementById('jenisPendaftaran').value = data.jenisPendaftaran;
        document.getElementById('namaSekolah').value = data.namaSekolah || '';
        document.getElementById('alamatSekolah').value = data.alamatSekolah || '';
        document.getElementById('pindahanKelas').value = data.pindahanKelas || '';
        // Kontak
        document.getElementById('noHp').value = data.noHp;
        document.getElementById('kontakEmail').value = data.kontakEmail;
        // Registered By
        document.getElementById('registeredBy').value = data.registeredBy;
      } catch (error) {
        console.error("Error loading data siswa:", error);
        alert("Terjadi kesalahan saat memuat data siswa.");
      }
    }

    document.addEventListener("DOMContentLoaded", loadDataSiswa);

    // Handle submit update data siswa
    document.getElementById('updateForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = document.getElementById('id').value;
      const formData = {
        taPendaftaran: document.getElementById('taPendaftaran').value,
        jalurPendaftaran: document.getElementById('jalurPendaftaran').value,
        program: document.getElementById('program').value,
        namaLengkap: document.getElementById('namaLengkap').value,
        namaPanggilan: document.getElementById('namaPanggilan').value,
        nisn: document.getElementById('nisn').value,
        nis: document.getElementById('nis').value,
        nik: document.getElementById('nik').value,
        tempatLahir: document.getElementById('tempatLahir').value,
        tanggalLahir: document.getElementById('tanggalLahir').value,
        jenisKelamin: document.getElementById('jenisKelamin').value,
        agama: document.getElementById('agama').value,
        alamatSiswa: document.getElementById('alamatSiswa').value,
        rt: document.getElementById('rt').value,
        rw: document.getElementById('rw').value,
        desa: document.getElementById('desa').value,
        kecamatan: document.getElementById('kecamatan').value,
        kabupaten: document.getElementById('kabupaten').value,
        provinsi: document.getElementById('provinsi').value,
        kodePos: document.getElementById('kodePos').value,
        namaAyah: document.getElementById('namaAyah').value,
        pekerjaanAyah: document.getElementById('pekerjaanAyah').value,
        pendidikanAyah: document.getElementById('pendidikanAyah').value,
        namaIbu: document.getElementById('namaIbu').value,
        pekerjaanIbu: document.getElementById('pekerjaanIbu').value,
        pendidikanIbu: document.getElementById('pendidikanIbu').value,
        hubunganWali: document.getElementById('hubunganWali').value,
        namaWali: document.getElementById('namaWali').value,
        pekerjaanWali: document.getElementById('pekerjaanWali').value,
        pendidikanWali: document.getElementById('pendidikanWali').value,
        jenisPendaftaran: document.getElementById('jenisPendaftaran').value,
        namaSekolah: document.getElementById('namaSekolah').value,
        alamatSekolah: document.getElementById('alamatSekolah').value,
        pindahanKelas: document.getElementById('pindahanKelas').value,
        noHp: document.getElementById('noHp').value,
        kontakEmail: document.getElementById('kontakEmail').value,
        registeredBy: document.getElementById('registeredBy').value
      };

      try {
        const response = await fetch(`/api/pendaftaran/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const result = await response.json();
        if (response.ok) {
          alert(result.message);
        } else {
          alert(result.message || "Gagal memperbarui data.");
        }
      } catch (error) {
        console.error("Error updating data siswa:", error);
        alert("Terjadi kesalahan saat mengirim data.");
      }
    });

    // Tombol Print PDF untuk detail data siswa
    document.getElementById('printButton').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("Detail Data Siswa", 14, 20);
      
      // Siapkan data untuk dicetak (mencakup semua field)
      const fields = [
        ["Tahun Pendaftaran", document.getElementById("taPendaftaran").value],
        ["Jalur Pendaftaran", document.getElementById("jalurPendaftaran").value],
        ["Program", document.getElementById("program").value],
        ["Nama Lengkap", document.getElementById("namaLengkap").value],
        ["Nama Panggilan", document.getElementById("namaPanggilan").value],
        ["NISN", document.getElementById("nisn").value],
        ["NIS", document.getElementById("nis").value],
        ["NIK / No. KIA", document.getElementById("nik").value],
        ["Tempat Lahir", document.getElementById("tempatLahir").value],
        ["Tanggal Lahir", document.getElementById("tanggalLahir").value],
        ["Jenis Kelamin", document.getElementById("jenisKelamin").value],
        ["Agama", document.getElementById("agama").value],
        ["Alamat Siswa", document.getElementById("alamatSiswa").value],
        ["RT", document.getElementById("rt").value],
        ["RW", document.getElementById("rw").value],
        ["Desa", document.getElementById("desa").value],
        ["Kecamatan", document.getElementById("kecamatan").value],
        ["Kabupaten", document.getElementById("kabupaten").value],
        ["Provinsi", document.getElementById("provinsi").value],
        ["Kode Pos", document.getElementById("kodePos").value],
        ["Nama Ayah", document.getElementById("namaAyah").value],
        ["Pekerjaan Ayah", document.getElementById("pekerjaanAyah").value],
        ["Pendidikan Ayah", document.getElementById("pendidikanAyah").value],
        ["Nama Ibu", document.getElementById("namaIbu").value],
        ["Pekerjaan Ibu", document.getElementById("pekerjaanIbu").value],
        ["Pendidikan Ibu", document.getElementById("pendidikanIbu").value],
        ["Hubungan Wali", document.getElementById("hubunganWali").value],
        ["Nama Wali", document.getElementById("namaWali").value],
        ["Pekerjaan Wali", document.getElementById("pekerjaanWali").value],
        ["Pendidikan Wali", document.getElementById("pendidikanWali").value],
        ["Jenis Pendaftaran (Sekolah Asal)", document.getElementById("jenisPendaftaran").value],
        ["Nama Sekolah", document.getElementById("namaSekolah").value],
        ["Alamat Sekolah", document.getElementById("alamatSekolah").value],
        ["Pindahan Kelas", document.getElementById("pindahanKelas").value],
        ["No HP", document.getElementById("noHp").value],
        ["Email", document.getElementById("kontakEmail").value],
        ["Registered By", document.getElementById("registeredBy").value],
      ];
      
      // Gunakan AutoTable untuk membuat tabel PDF
      doc.autoTable({
        head: [["Field", "Value"]],
        body: fields,
        startY: 30,
        theme: 'grid',
        headStyles: { fillColor: [46, 204, 113] },
        styles: { fontSize: 10 }
      });
      
      doc.save("DetailDataSiswa.pdf");
    });
  </script>
</body>
</html>
